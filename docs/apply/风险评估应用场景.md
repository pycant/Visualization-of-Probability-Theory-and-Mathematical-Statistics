
即可直接拖进 VSCode，用 Markdown Preview Enhanced 秒变交互网页。  

# 风险评估中的概率统计
> VSCode + Jupyter 内核运行，Markdown Preview Enhanced 秒变网页

---

## 0. 金融前置知识 5 分钟速通（非概率部分）
> 本节 **零公式**，只看图 & 类比，把“金融”变“常识”

| 概念 | 一句话类比 | 交互速览 |
|---|---|---|
| **杠杆** | 花呗分期：10 元买 100 元东西，收益放大，爆仓也放大 | <details><summary>⚖️ 杠杆滑杆</summary><input type="range" min="1" max="10" value="2" oninput="this.nextElementSibling.innerText='杠杆倍数='+this.value">杠杆倍数=2</details> |
| **流动性** | 公交卡余额：提现秒到=高流动性，定期存款=低流动性 | <details><summary>💧 流动性按钮</summary><button onclick="alert('熔断机制：流动性骤降→滑点飙升→VaR 失效！')">点我弹出流动性黑洞</button></details> |
| **多空对冲** | 下雨天带伞：股票多头+期货空头=湿鞋但不湿身 | <details><summary>☂️ 多空开关</summary><label><input type="checkbox" onchange="document.getElementById('hedge').innerText=this.checked?'组合β≈0':'组合β=1'">开启对冲</label> <span id="hedge">组合β=1</span></details> |
| **熔断机制** | 电闸：跌≥7% 全市场停电 15 min，给情绪降温 | <details><summary>🔥 熔断按钮</button><button onclick="this.innerText=['正常交易','一级熔断','二级熔断'][Math.floor(Math.random()*3)]">模拟熔断</button></details> |
| **Basel 协议** | 安全带：银行核心资本≥8%，防止翻车 | <details><summary>🚗 资本滑杆</summary><input type="range" min="5" max="15" value="8" oninput="this.nextElementSibling.innerText='核心资本 '+this.value+'%'">核心资本 8%</details> |

---

## 1. 示例展示（Example Showcase）

**目标：** 30 秒看懂「历史模拟 vs 蒙特卡洛 VaR」谁更靠谱**

**核心交互：** 「投资组合」双模型对决

功能：
1. 输入任意股票代码 → 实时显示「历史 VaR」+「蒙特卡洛 VaR」
2. 一键「回溯 1000 天」→ 看两种 VaR 随时间逼近真实突破
3. 揭示真相：点击「真实损失」→ 显示突破次数 vs 概率校准图
4. 小总结：历史法 = 只看过去，蒙特卡洛 = 随机未来

💡 小提示：把置信水平拖到 99%，蒙特卡洛 VaR 更宽——这就是尾部分布！

---

## 2. 理论探索（Theoretical Exploration）

**标题：** 3 步拆解金融风险中的概率——从收益率到 VaR

---

### 知识点 1/3：收益率分布与对数正态

<details>
<summary>📖 专业名词速查（点击展开）</summary>

- **对数收益率**：r_t = ln(P_t / P_{t-1})，近似正态
- **厚尾**：实际峰度 > 3，出现黑天鹅
- **波动率聚类**：高波动后仍高，ARCH/GARCH 建模
</details>

#### ① 逐步推导（点击展开）
<details>
<summary>🔍 逐步推导（点击展开）</summary>

步骤 1：写价格过程  
P_t = P_{t-1} exp(μΔt + σ√Δt Z), Z∼N(0,1)

步骤 2：对数收益率  
r_t = ln(P_t / P_{t-1}) = μΔt + σ√Δt Z

步骤 3：求 VaR  
VaR_α = -P_0 (μΔt + σ√Δt z_α)
</details>

#### ② 趣味性可视化
- 滑块调 σ → 实时画收益率分布，看尾部随 σ 变厚
- 点击「加速到 σ=40%」→ 肉眼验证「厚尾」

#### ③ 代码（Jupyter 内核直接跑）
```python
import numpy as np
import matplotlib.pyplot as plt

mu, sigma = 0, 0.02          # 日收益均值 & 标准差
days = 252                   # 1 年
r = np.random.normal(mu, sigma, days)
plt.figure(figsize=(6,3))
plt.hist(r, bins=50, density=True, alpha=0.6, color='#FF6B6B', label='真实收益')
x = np.linspace(-0.1, 0.1, 200)
plt.plot(x, (1/np.sqrt(2*np.pi*sigma**2))*np.exp(-(x-mu)**2/(2*sigma**2)), 'k--', label='正态拟合')
plt.xlabel('日收益'); plt.ylabel('密度'); plt.title('收益率分布'); plt.legend(); plt.show()
```

---

### 知识点 2/3：VaR 三大法门 —— 历史·方差协方差·蒙特卡洛

<details>
<summary>📖 专业名词速查（点击展开）</summary>

- **历史模拟法**：直接用历史分位数，无分布假设
- **方差-协方差法**：假设多元正态，快速解析解
- **蒙特卡洛法**：随机模拟未来路径，灵活但耗时
</details>

#### ① 逐步推导（点击展开）
<details>
<summary>🔍 逐步推导（点击展开）</summary>

步骤 1：历史法  
VaR = -percentile(r_history, α)

步骤 2：方差-协方差法  
VaR = -(μ + z_α σ) P_0

步骤 3：蒙特卡洛法  
生成 N 条路径 → 计算组合收益 → 取 α 分位数
</details>

#### ② 趣味性可视化
- 滑块调 α ∈[0.9,0.99] → 实时看 VaR 竖线移动
- 点击「导出 CSV」→ 自己算 ES（Expected Shortfall）

#### ③ 代码（Jupyter 内核直接跑）
```python
import numpy as np
import pandas as pd
import yfinance as yf

tickers = ['AAPL', 'MSFT', 'GOOG']
start = '2020-01-01'
end   = '2023-01-01'
prices = yf.download(tickers, start, end)['Adj Close']
rets   = prices.pct_change().dropna()
w      = np.array([0.3, 0.4, 0.3])          # 组合权重
port_rets = rets.dot(w)

# 三种 VaR（1 天，95%）
alpha = 0.05
P0 = 1e6                                     # 1 百万组合
hist_VaR = -np.percentile(port_rets, alpha*100) * P0
mc_rets  = np.random.choice(port_rets, size=50000)
mc_VaR   = -np.percentile(mc_rets, alpha*100) * P0
norm_VaR = -(port_rets.mean() + np.sqrt(port_rets.var()) * np.nanpercentile(np.random.randn(1e6), alpha*100)) * P0

print(f'历史模拟 VaR = {hist_VaR:,.0f} 元')
print(f'蒙特卡洛 VaR = {mc_VaR:,.0f} 元')
print(f'正态解析 VaR = {norm_VaR:,.0f} 元')
```

---

### 知识点 3/3：回测与校准 —— VaR 必须可信

<details>
<summary>📖 专业名词速查（点击展开）</summary>

- **突破率**：真实损失 > VaR 的天数占比
- **Kupiec 检验**：LR = -2ln[(1-p)^{T-N} p^N] + 2ln[(1-N/T)^{T-N} (N/T)^N] ~ χ²(1)
- **Brier 分数**：(1/N) Σ(I_t - α)²，越低越准
</details>

#### ① 逐步推导（点击展开）
<details>
<summary>🔍 逐步推导（点击展开）</summary>

步骤 1：计算每日突破指示 I_t = 1_{Loss_t > VaR_t}  
步骤 2：突破率 p̂ = ΣI_t / T  
步骤 3：Kupiec LR 检验，p 值 > 0.05 则模型通过
</details>

#### ② 趣味性可视化
- 一键「重复 1000 次」→ 实时画可靠性曲线，看 95% VaR 是否≈5% 突破
- 点击「导出 CSV」→ 自己算 Brier & ES

#### ③ 代码（Jupyter 内核直接跑）
```python
import matplotlib.pyplot as plt
from scipy.stats import chi2

# 回测示例（静态 VaR）
VaR_day = -np.percentile(port_rets, 5) * P0
losses  = -port_rets * P0
breaches = losses > VaR_day
p_hat = breaches.mean()
T, N = len(breaches), breaches.sum()
LR = -2*(np.log((1-alpha)**(T-N) * alpha**N) - np.log((1-p_hat)**(T-N) * p_hat**N))
p_value = 1 - chi2.cdf(LR, df=1)

print(f'突破率 = {p_hat:.2%}, Kupiec p = {p_value:.3f}')
if p_value > 0.05:
    print('✅ VaR 模型通过检验')
else:
    print('❌ VaR 模型校准不良')

# 可靠性曲线
plt.figure(figsize=(4,4))
plt.plot([0,1], [0,1], 'k--', label='完美校准')
plt.scatter([0.05], [p_hat], color='#FF6B6B', s=100, label='实测')
plt.xlabel('预期突破率'); plt.ylabel('实际突破率'); plt.title('VaR 可靠性'); plt.legend(); plt.show()
```

---

## 3. 实践应用（Practical Applications）

> 每个应用 =「分步引导 + 核心知识点 + 小测试」  
> 必须逐步点击「已完成」才能解锁下一步；全部完成后弹出「知识点考察」。

---

### 应用一：VaR 回测仪表盘 —— 历史·蒙特卡洛·正态

#### 第①步：上传组合
功能：
1. 拖拽 CSV（日期+市值）→ 自动算日收益
2. 核心知识点卡片：「突破率应≈1−α」
3. 点击「我已了解」→ 解锁第②步

#### 第②步：选择方法
功能：
1. 单选按钮：「历史」「方差-协方差」「蒙特卡洛」
2. 滑块调 α ∈[0.9,0.99]
3. 点击「方法已选定」→ 解锁第③步

#### 第③步：计算 VaR
功能：
1. 点击「计算 1000 天」→ 进度条跑完，保存 VaR 序列
2. 实时显示「突破次数」「突破率 p」「Kupiec p 值」
3. 点击「计算完成」→ 解锁第④步

#### 第④步：回测与校准
功能：
1. 画「实际损失 vs VaR」曲线，突破点标红
2. 显示 Brier 分数 & ES
3. 点击「导出 CSV」→ 自己算 ES
4. 点击「回测完成」→ 弹出「知识点考察」

<!-- === 应用通关网关=== -->
<div class="app-gate" data-app="1">
  <button class="exam-btn">开始知识点考察（3 题）</button>
  <div class="exam-paper" style="display:none;">
    <ol>
      <li>单选：95% VaR 表示？
        <br/><label><input type="radio" name="q1" value="A"> A. 一天内最大收益</label>
        <br/><label><input type="radio" name="q1" value="B"> B. 5% 分位点损失</label>
        <br/><label><input type="radio" name="q1" value="C"> C. 平均损失</label>
      </li>
      <li>判断：突破率长期≈5% 说明 VaR 模型校准良好。（√）</li>
      <li>单选：Kupiec 检验用于？
        <br/><label><input type="radio" name="q3" value="A"> A. 检验突破率是否显著≠1−α</label>
        <br/><label><input type="radio" name="q3" value="B"> B. 检验收益率正态性</label>
        <br/><label><input type="radio" name="q3" value="C"> C. 检验组合权重</label>
      </li>
    </ol>
  <button class="submit-exam">提交</button>
  <div class="exam-result" style="display:none;"></div>
</div>
</div>

<script>
/* ========= 应用通关逻辑 ========= */
document.querySelector('.exam-btn').addEventListener('click',e=>{
  document.querySelector('.exam-paper').style.display='block';
});
document.querySelector('.submit-exam').addEventListener('click',e=>{
  const ans=['B','√','A'];
  let score=0;
  ans.forEach((a,i)=>{
    const user=document.querySelector(`input[name="q${i+1}"]:checked`)?.value;
    if(user===a) score++;
  });
  const pass=score>=2;
  document.querySelector('.exam-result').innerHTML=
    `${pass?'✅ 通关':'❌ 未通关'} 得分：${score}/3  
     <button onclick="location.reload()">${pass?'进入下一应用':'重考'}</button>`;
  document.querySelector('.exam-result').style.display='block';
});
</script>

---

## 4. 章节练习（Chapter Exercises）

**Level 3 分析与设计**  
功能：  
1. 设计一个「估算 99% ES（Expected Shortfall）」的抽样方案，说明如何选样本量 n、如何控制蒙特卡洛误差  
2. 如果组合含期权，给出两条处理非线性 VaR 的策略（提示：Delta-Gamma、Full Revaluation）  

---

### 1. 估算 99% ES 抽样方案（点击展开）
<details>
<summary>🎯 实验设计（点击展开）</summary>

#### ① 理论关系  
ES_α = E[Loss | Loss > VaR_α] ≈ 平均尾部样本  

#### ② 样本量选择  
- 相对误差 ≤10% → 需尾部样本 ≥200  
- α=0.01 ⇒ 总样本 N ≥ 200/0.01 = 20 000  

#### ③ 误差控制  
- 使用对偶变量/控制变量降低方差  
- 分批计算，标准误 SE = s_tail/√k  

#### ④ 代码
```python
N = 20000
r = np.random.normal(0, 0.02, N)
VaR99 = -np.percentile(r, 1)
tail = r[r <= -VaR99]
ES99 = -tail.mean()
print(f'99% ES ≈ {ES99*100:.2%} | 尾部样本={len(tail)}')
```
</details>

---

### 2. 期权组合非线性 VaR 策略（点击展开）
<details>
<summary>📉 策略详情（点击展开）</summary>

| 策略 | 核心思想 | 公式/代码 |
|---|---|---|
| **Delta-Gamma** | 二阶泰勒展开，快速近似 | ΔP ≈ Δ·ΔS + ½Γ·(ΔS)² |
| **Full Revaluation** | 重新定价，最准最慢 | 蒙特卡洛生成价格→逐条折现 |
| **Scenario Matrix** | 预计算格点，查表插值 | 速度与精度折中 |

```python
# Delta-Gamma 近似示例
delta = 0.6
gamma = 0.02
dS = -0.03
dP = delta * dS + 0.5 * gamma * dS**2
print(f'Delta-Gamma 近似损失 = {dP:.2%}')
```
</details>

---

## 5. 网页内容设计概要（UI/UX）

- **顶部：** 标题「风险评估中的概率统计」+ 一句 slogan「用概率管住风险」
- **左侧：** 固定导航栏，直接链接到【速通】【示例】【理论】【应用】【练习】
- **布局：**  
  - 【速通】部分：5 张折叠卡片，首屏 60%，右侧留空给「美元猫🐱」GIF  
  - 【示例】部分：双滑杆占 70%，按钮悬浮底部，不打断动画  
  - 【理论】部分：3 张可折叠卡片，每卡右侧留 15% 给「AI 助手」与「解锁按钮」  
  - 【应用】部分：分步卡片，必须点击「已完成」才能解锁；完成后弹出「知识点考察」  
  - 【练习】部分：Level3 默认折叠，答题后展开解析与回链
- **视觉：** 主色 #FF6B6B（风险红），辅助灰 #E0E0E0，所有轨迹默认半透明 0.6

---

## 6. 附：完整 Level3 答题代码（Jupyter 一键运行）

```python
# 99% ES 估算
N = 20000
r = np.random.normal(0, 0.02, N)
VaR99 = -np.percentile(r, 1)
tail = r[r <= -VaR99]
ES99 = -tail.mean()
print(f'99% ES ≈ {ES99*100:.2%} | 尾部样本={len(tail)}')

# Delta-Gamma 近似
delta, gamma = 0.6, 0.02
dS = -0.03
dP = delta * dS + 0.5 * gamma * dS**2
print(f'Delta-Gamma 近似损失 = {dP:.2%}')
```
```